os: linux
language: cpp
notifications:
  email: false

matrix:
  include:

    # Clang 6.0
    - name: "Trusty Clang 6.0"
      env: _CXX=clang++-6.0
      dist: trusty
      addons: &clang60
        apt:
          packages:
            - clang-6.0
            - g++-7
            - libhwloc-dev
            - libopenmpi-dev
            - libtool
            - openmpi-bin
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty-6.0
            - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main'
              key_url: 'https://apt.llvm.org/llvm-snapshot.gpg.key'

    # GCC 7
    - name: "Trusty GCC 7"
      env: _CXX=g++-7
      dist: trusty
      addons: &gcc7
        apt:
          packages:
            - g++-7
            - libhwloc-dev
            - libopenmpi-dev
            - libtool
            - openmpi-bin
          sources:
            - ubuntu-toolchain-r-test

    # GCC 7
    - name: "Xenial GCC 7"
      env: _CXX=g++-7
      dist: xenial
      addons: &gcc7
        apt:
          packages:
            - g++-7
            - libopenmpi-dev
            - libtool-bin
          sources:
            - ubuntu-toolchain-r-test

    # Python 3
    - name: "Xenial Python 3"
      dist: xenial
      language: python
      python: 3.6

install:
  - |
    if [[ ! -z "${_CXX}" ]]; then
      export CXX=${_CXX}
      CMAKE_VER=3.13.4
      CMAKE_URL="https://cmake.org/files/v${CMAKE_VER%.[0-9]}/cmake-${CMAKE_VER}-Linux-x86_64.tar.gz"
      mkdir cmake && travis_retry wget --no-check-certificate -O - ${CMAKE_URL} | tar --strip-components=1 -xz -C cmake
      export PATH=${DEPS_DIR}/cmake/bin:${PATH}
      cd ${TRAVIS_BUILD_DIR}
      cmake --version
      ./install-deps
    fi
before_script:
  - cd tests
script:
  - |
    [[ ! -z "${_CXX}" ]] && make unit-test || make generate-test
